{% extends "base.html" %}
{% load static %}

{% block title %}
{% if object %}Modifier{% else %}Cr√©er{% endif %} une recette
{% endblock %}

{% block content %}
<section class="bg-gray-50 min-h-screen pb-24">

<!-- ================= HEADER ================= -->
<header class="sticky top-0 z-50 bg-blue-600 text-white shadow">
  <div class="max-w-screen-xl mx-auto px-6 py-3 flex justify-between items-center">
    <h1 class="text-xl font-bold">
      {% if object %}‚úèÔ∏è Modifier{% else %}‚ûï Nouvelle{% endif %} recette
    </h1>
    {% if object %}
      <span class="text-sm opacity-80 truncate max-w-md">
        {{ recette.titre }}
      </span>
    {% endif %}
  </div>
</header>

<form method="post"
      enctype="multipart/form-data"
      class="max-w-screen-xl mx-auto px-6 py-6 space-y-6">
  {% csrf_token %}

  <!-- ================= ERREURS GLOBALES ================= -->
  {% if form.non_field_errors %}
    <div class="rounded-lg border border-red-300 bg-red-50 p-4">
      <h3 class="font-semibold text-red-700 mb-2">‚ùå Erreurs</h3>
      <ul class="list-disc list-inside text-sm text-red-600">
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- ================= RECETTE ================= -->
  <section class="bg-white rounded-xl shadow p-6">
    <div class="text-lg text-blue-600 mb-4 font-semibold">Recette</div>

    <div class="grid grid-cols-12 gap-4">
      <div class="col-span-12 md:col-span-8">
        {{ form.titre }}
        {{ form.titre.errors }}
      </div>

      <div class="col-span-12 md:col-span-4">
        {{ form.categorie }}
        {{ form.categorie.errors }}
      </div>

      <div class="col-span-12">
        {{ form.description }}
        {{ form.description.errors }}
      </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
      <div>Pr√©paration en minute</div>
      <div>Cuisson en minute</div>
      <div>Nombre de couvert</div>
      <div>Note</div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
      <div>{{ form.temps_preparation }}</div>
      <div>{{ form.temps_cuisson }}</div>
      <div>{{ form.nombre_couverts }}</div>
      <div>{{ form.note }}</div>
    </div>
  </section>

  <!-- ================= INGR√âDIENTS ================= -->
  <section class="bg-white rounded-xl shadow">
     <details open class="p-4 border-b">
      <summary class="Text-lg font-bold text-blue-600 font-semibold cursor-pointer">
          Ingr√©dients
          <span class="text-sm text-gray-400">(Choisir le "Groupe Ingr√©dients" pour regrouper des ingr√©dients)</span>
      </summary>

    {% if ingredients.non_form_errors %}
      <div class="mb-4 border border-red-300 bg-red-50 p-3 rounded">
        <ul class="list-disc list-inside text-sm text-red-600">
          {% for error in ingredients.non_form_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {{ ingredients.management_form }}

    <div id="ingredient-list" class="space-y-1">
      {% for form in ingredients %}
        <div class="
          ingredient-row
          grid grid-cols-12 gap-1 items-center px-2 py-1 text-sm rounded
          {% if form.errors %} bg-red-50 border border-red-300 {% else %} bg-gray-50 {% endif %}
        ">
          {{ form.id }}{{ form.ordre }}

          <div class="col-span-1 text-gray-400 cursor-move">‚ò∞</div>
          <div class="col-span-1">{{ form.qte }}</div>
          <div class="col-span-2">{{ form.unit }}</div>
          <div class="col-span-7">
          <div class="{% if form.unit.value == '--' %}
             Text-lg font-bold text-blue-600
            {% else %}
            {% endif %}">
            {{ form.description }}
          </div>
          </div>

          <div class="col-span-1 flex justify-end gap-1">
            {{ form.DELETE }}
            <button type="button" class="delete-ingredient text-red-600">
              üóë
            </button>
          </div>
        </div>
      {% endfor %}
    </div>

    <button type="button"
            id="add-ingredient"
            class="mt-3 bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">
      ‚ûï Ajouter un ingr√©dient
    </button>

    <!-- Prototype -->
    <template id="ingredient-empty-form">
      <div class="grid grid-cols-12 gap-1 items-center px-2 py-1 text-sm bg-gray-50 rounded ingredient-row">
        {{ ingredients.empty_form.id }}{{ ingredients.empty_form.ordre }}
        <div class="col-span-1 text-gray-400">‚ò∞</div>
        <div class="col-span-1">{{ ingredients.empty_form.qte }}</div>
        <div class="col-span-2">{{ ingredients.empty_form.unit }}</div>
        <div class="col-span-7">{{ ingredients.empty_form.description }}</div>
        <div class="col-span-1"></div>
      </div>
    </template>
     </details>
  </section>

  <!-- ================= √âTAPES / CONSEILS ================= -->
  <section class="bg-white rounded-xl shadow">
    <details open class="p-4 border-b">
      <summary class="Text-lg font-bold text-blue-600 font-semibold cursor-pointer">
        √âtapes
        <span class="text-sm text-gray-400">(Commencer la ligne "- " pour d√©finir une √©tape cl√©)</span>
      </summary>
      <div class="relative">
        <pre id="etapes-highlight"
             class="absolute inset-0 pointer-events-none overflow-hidden"></pre>

        {{ form.etapes }}
      </div>

    </details>

    <details open class="p-4 border-b">
      <summary class="Text-lg font-bold text-blue-600 font-semibold cursor-pointer">
        Conseils
        <span class="text-sm text-gray-400">(Commencer la ligne "- " pour d√©finir un conseil cl√©)</span>
      </summary>
      <div class="mt-3 relative">
        {{ form.conseils }}
      </div>
    </details>
  </section>

  <!-- ================= M√âDIAS ================= -->
  <section class="bg-white rounded-xl shadow">
    <details open class="p-4 border-b">
      <summary class="Text-lg font-bold text-blue-600 mt-4 font-semibold cursor-pointer">
      M√©dias
      </summary>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
      <div>
        {{ form.image }}
        {% if object.image %}
          <img src="{{ object.image.url }}"
               class="mt-2 rounded shadow max-h-32">
        {% endif %}
      </div>

      <div>
        {{ form.video_url_youtube }}
      </div>
    </div>
      </details>
   </section>
  <!-- ================= ACTIONS FIXES ================= -->
  <div class="fixed bottom-0 inset-x-0 bg-white border-t shadow px-6 py-3 flex justify-between items-center">
    <a href="{% url 'recettes:recettes' %}"
       class="text-gray-600 hover:text-gray-800">
      ‚Üê Annuler
    </a>

    <div class="flex gap-2">
      <button type="submit"
              name="_continue"
              value="1"
              class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
        üíæ Continuer
      </button>

      <button type="submit"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        üíæ Enregistrer
      </button>
    </div>
  </div>

</form>
</section>
{% endblock %}
